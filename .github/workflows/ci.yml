name: CI/CD Pipeline

# Trigger for different events
on:
  # Trigger tests on push to the main branch or release branches
  push:
    branches:
      - main # Run tests on direct pushes to the main branch
      - 'release/v[0-9]+\.[0-9]+\.[0-9]+' # Run tests on pushes to release branches like release/v10.12.01

  # Trigger build only when release branches are merged
  pull_request:
    branches:
      - 'release/v[0-9]+\.[0-9]+\.[0-9]+' # Only trigger on pull requests for release branches
    types: [closed] # Only trigger when the pull request is closed (merged)

jobs:
  # Test job for pushes to main and release branches
  test:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Checkout code from the repository
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Set up Python (you can replace this depending on your project)
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      # Step 3: Install dependencies (from requirements.txt)
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      # Step 4: Run mypy to check type hints
      - name: Run mypy
        run: |
          pip install mypy
          mypy your_python_package/  # Replace with the path to your Python code

      # Step 5: Run tests using pytest (this is the unit test step)
      - name: Run tests
        run: |
          pytest  # This runs your unit tests using pytest

  # Build and deploy job only when a release branch is merged
  build-and-deploy:
    if: github.event.pull_request.merged == true # Ensure this job runs only when a pull request is merged
    runs-on: ubuntu-latest
    steps:
      # Step 1: Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Set up Python (replace with your preferred setup)
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      # Step 3: Install dependencies (from requirements.txt)
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      # Step 4: Build Docker image with a custom tag (e.g., v1.0.0-abc1234)
      - name: Build Docker image with custom tag
        run: |
          TAG_NAME="${GITHUB_REF#refs/tags/}"  # Extract tag name if it's a tag push
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"  # Extract branch name if it's a branch push

          # Define custom tag based on the event type
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            IMAGE_TAG="$TAG_NAME-${GITHUB_SHA:0:7}"
          elif [[ $GITHUB_REF == refs/heads/release/* ]]; then
            IMAGE_TAG="$BRANCH_NAME-${GITHUB_SHA:0:7}"
          fi

          echo "Building Docker image with tag: $IMAGE_TAG"
          docker build -t pv-fastapi-async-crud:$IMAGE_TAG .

      # Step 5: Log in to Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: palakornv # Replace with your Docker Hub username
          password: ${{ secrets.DOCKER_HUB_TOKEN }} # Docker Hub password/token stored in GitHub Secrets

      # Step 6: Push Docker image to Docker Hub
      - name: Push Docker image to Docker Hub
        run: |
          docker tag pv-fastapi-async-crud:$IMAGE_TAG palakornv/pv-fastapi-async-crud:$IMAGE_TAG
          docker push palakornv/pv-fastapi-async-crud:$IMAGE_TAG
          echo "Pushed Docker image with tag: $IMAGE_TAG"

      # Step 7: Deploy to Servers
